#include <iostream>
#include <fstream>
#include <sstream>
#include <iomanip>
#include <string>

using namespace std;

const int MAX_Pakaian = 100;

struct Pakaian{
    int id;
    string merek;
    string kategori;
    string tipe;//style,model,dll
    unsigned int ukuran;//dalam cm
    int stok;
    double harga;
};

Pakaian daftarPakaian[MAX_Pakaian];
int jumlahPakaian = 0;

// ================== FUNGSI UTILITAS ==================
void muatDariFile(const string &namaFile) {
    ifstream file(namaFile);
    if (!file.is_open()) {
        // Jika file belum ada, anggap kosong
        cout << "File " << namaFile << " belum ada. Mulai dengan data kosong.\n";
        return;
    }

    jumlahPakaian = 0;
    string line;
    while (getline(file, line) && jumlahPakaian < MAX_Pakaian) {
        if (line.empty()) continue;

        stringstream ss(line);
        string idStr, merekstr, kategoristr, tipestr, ukuranStr, stokStr, hargaStr;

        // Format: id|nama|stok|harga
        if (!getline(ss, idStr, '|')) continue;
        if (!getline(ss, merekstr, '|')) continue;
        if (!getline(ss, kategoristr, '|')) continue;
        if (!getline(ss, tipestr, '|')) continue;
        if (!getline(ss, ukuranStr, '|')) continue;
        if (!getline(ss, stokStr, '|')) continue;
        if (!getline(ss, hargaStr, '|')) continue;

        Pakaian b;
        b.id   = stoi(idStr);
        b.merek = merekstr;
        b.kategori = kategoristr;
        b.tipe = tipestr;
        b.ukuran = stoi(ukuranStr);
        b.stok = stoi(stokStr);
        b.harga = stod(hargaStr);

        daftarPakaian[jumlahPakaian++] = b;
    }

    file.close();
    cout << "Data berhasil dimuat dari " << namaFile << ". Jumlah Pakaian: " 
         << jumlahPakaian << "\n";
}

void simpanKeFile(const string &namaFile) {
    ofstream file(namaFile);
    if (!file.is_open()) {
        cout << "Gagal membuka file " << namaFile << " untuk disimpan.\n";
        return;
    }

    for (int i = 0; i < jumlahPakaian; ++i) {
        file << daftarPakaian[i].id   << "|"
             << daftarPakaian[i].merek << "|"
             << daftarPakaian[i].kategori << "|"
             << daftarPakaian[i].tipe << "|"
             << daftarPakaian[i].ukuran << "|"
             << daftarPakaian[i].stok << "|"
             << daftarPakaian[i].harga << "\n";
    }

    file.close();
    cout << "Data berhasil disimpan ke " << namaFile << "\n";
}

int cariIndexById(int id) {
    for (int i = 0; i < jumlahPakaian; ++i) {
        if (daftarPakaian[i].id == id) return i;
    }
    return -1;
}

// ================== CRUD ==================
void tampilkanPakaian() {
    if (jumlahPakaian == 0) {
        cout << "Belum ada data Pakaian.\n";
        return;
    }

    cout << left << setw(5)  << "ID"
         << left << setw(20) << "Nama"
         << left << setw(10) << "Stok"
         << left << setw(10) << "Harga" << "\n";
    cout << string(50, '-') << "\n";

    for (int i = 0; i < jumlahPakaian; ++i) {
        cout << left << setw(5)  << daftarPakaian[i].id
             << left << setw(20) << daftarPakaian[i].merek
             << left << setw(15) << daftarPakaian[i].kategori
             << left << setw(15) << daftarPakaian[i].tipe
             << left << setw(10) << daftarPakaian[i].ukuran
             << left << setw(10) << daftarPakaian[i].stok
             << left << setw(10) << daftarPakaian[i].harga
             << "\n";
    }
}

void tambahPakaian() {
    if (jumlahPakaian >= MAX_Pakaian) {
        cout << "Array penuh, tidak bisa menambah Pakaian lagi.\n";
        return;
    }

    Pakaian b;
    cout << "Masukkan ID         : ";
    cin >> b.id;
    cin.ignore(); // bersihkan newline

    if (cariIndexById(b.id) != -1) {
        cout << "ID sudah digunakan, silakan pakai ID lain.\n";
        return;
    }

    cout << "Masukkan Nama Pakaian: ";
    getline(cin, b.nama);

    cout << "Masukkan Stok       : ";
    cin >> b.stok;

    cout << "Masukkan Harga      : ";
    cin >> b.harga;

    daftarPakaian[jumlahPakaian++] = b;
    cout << "Pakaian berhasil ditambahkan.\n";
}

void ubahPakaian() {
    if (jumlahPakaian == 0) {
        cout << "Belum ada data Pakaian.\n";
        return;
    }

    int id;
    cout << "Masukkan ID Pakaian yang akan diubah: ";
    cin >> id;
    cin.ignore();

    int index = cariIndexById(id);
    if (index == -1) {
        cout << "Pakaian dengan ID " << id << " tidak ditemukan.\n";
        return;
    }

    cout << "Data lama:\n";
    cout << "Nama  : " << daftarPakaian[index].nama << "\n";
    cout << "Stok  : " << daftarPakaian[index].stok << "\n";
    cout << "Harga : " << daftarPakaian[index].harga << "\n\n";

    Pakaian &b = daftarPakaian[index];
    string input;
    
    cout << "Nama baru (kosongkan jika tidak diubah): ";
    getline(cin, input);
    if (!input.empty()) b.nama = input;

    cout << "Stok baru (isi -1 jika tidak diubah)   : ";
    int stokBaru;
    cin >> stokBaru;
    if (stokBaru != -1) b.stok = stokBaru;

    cout << "Harga baru (isi -1 jika tidak diubah)  : ";
    double hargaBaru;
    cin >> hargaBaru;
    if (hargaBaru != -1) b.harga = hargaBaru;

    cout << "Data Pakaian berhasil diubah.\n";
}

void hapusPakaian() {
    if (jumlahPakaian == 0) {
        cout << "Belum ada data Pakaian.\n";
        return;
    }

    int id;
    cout << "Masukkan ID Pakaian yang akan dihapus: ";
    cin >> id;

    int index = cariIndexById(id);
    if (index == -1) {
        cout << "Pakaian dengan ID " << id << " tidak ditemukan.\n";
        return;
    }

    // Geser elemen setelahnya ke depan
    for (int i = index; i < jumlahPakaian - 1; ++i) {
        daftarPakaian[i] = daftarPakaian[i + 1];
    }
    jumlahPakaian--;

    cout << "Pakaian berhasil dihapus.\n";
}

// ================== MENU ==================
void tampilkanMenu() {
    cout << "\n=== MENU CRUD Pakaian ===\n";
    cout << "1. Tampilkan Semua Pakaian\n";
    cout << "2. Tambah Pakaian\n";
    cout << "3. Ubah Pakaian\n";
    cout << "4. Hapus Pakaian\n";
    cout << "5. Simpan ke File\n";
    cout << "0. Keluar\n";
    cout << "Pilihan: ";
}

int main() {
    string namaFile = "Pakaian.txt";
    muatDariFile(namaFile);

    int pilihan;
    do {
        tampilkanMenu();
        cin >> pilihan;
        cin.ignore(); // bersihkan newline

        switch (pilihan) {
            case 1:
                tampilkanPakaian();
                break;
            case 2:
                tambahPakaian();
                break;
            case 3:
                ubahPakaian();
                break;
            case 4:
                hapusPakaian();
                break;
            case 5:
                simpanKeFile(namaFile);
                break;
            case 0:
                cout << "Keluar program...\n";
                break;
            default:
                cout << "Pilihan tidak valid.\n";
        }
    } while (pilihan != 0);

    // Otomatis simpan saat keluar (opsional)
    simpanKeFile(namaFile);

    return 0;
}
