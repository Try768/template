#include <iostream>
#include <fstream>
#include <sstream>
#include <iomanip>
#include <string>

using namespace std;

const int MAX_material = 100;

struct material{
    int id;
    string jenis_material;
    string keterangan;
    unsigned int berat;//dalam kg
    int stok;
    double harga;
};

material daftarmaterial[MAX_material];
int jumlahmaterial = 0;

// ================== FUNGSI UTILITAS ==================
void muatDariFile(const string &namaFile) {
    ifstream file(namaFile);
    if (!file.is_open()) {
        // Jika file belum ada, anggap kosong
        cout << "File " << namaFile << " belum ada. Mulai dengan data kosong.\n";
        return;
    }

    jumlahmaterial = 0;
    string line;
    while (getline(file, line) && jumlahmaterial < MAX_material) {
        if (line.empty()) continue;

        stringstream ss(line);
        string idStr,jenisstr, ketstr, beratStr, stokStr, hargaStr;

        // Format: id|nama|stok|harga
        if (!getline(ss, idStr, '|')) continue;
        if (!getline(ss, jenisstr, '|')) continue;
        if (!getline(ss, ketstr, '|')) continue;
        if (!getline(ss, beratStr, '|')) continue;
        if (!getline(ss, stokStr, '|')) continue;
        if (!getline(ss, hargaStr, '|')) continue;

        material b;
        b.id   = stoi(idStr);
        b.jenis_material = jenisstr;
        b.keterangan = ketstr;
        b.berat = stoi(beratStr);
        b.stok = stoi(stokStr);
        b.harga = stod(hargaStr);

        daftarmaterial[jumlahmaterial++] = b;
    }

    file.close();
    cout << "Data berhasil dimuat dari " << namaFile << ". Jumlah jenis material: " 
         << jumlahmaterial << "\n";
}

void simpanKeFile(const string &namaFile) {
    ofstream file(namaFile);
    if (!file.is_open()) {
        cout << "Gagal membuka file " << namaFile << " untuk disimpan.\n";
        return;
    }

    for (int i = 0; i < jumlahmaterial; ++i) {
        file << daftarmaterial[i].id   << "|"
             << daftarmaterial[i].jenis_material << "|"
             << daftarmaterial[i].keterangan<< "|"
             << daftarmaterial[i].berat << "|"
             << daftarmaterial[i].stok << "|"
             << daftarmaterial[i].harga << "\n";
    }

    file.close();
    cout << "Data berhasil disimpan ke " << namaFile << "\n";
}

int cariIndexById(int id) {
    for (int i = 0; i < jumlahmaterial; ++i) {
        if (daftarmaterial[i].id == id) return i;
    }
    return -1;
}

// ================== CRUD ==================
void tampilkanmaterial() {
    if (jumlahmaterial == 0) {
        cout << "Belum ada data material.\n";
        return;
    }

    cout << left << setw(5)  << "ID"
         << left << setw(20) << "jenis material"
         <<left<< setw(15)<<"keterangan"
         <<left<<setw(10)<<"berat(kg)"
         << left << setw(10) << "Stok"
         << left << setw(10) << "Harga" << "\n";

    cout << string(50, '-') << "\n";

    for (int i = 0; i < jumlahmaterial; ++i) {
        cout << left << setw(5)  << daftarmaterial[i].id
             << left << setw(20) << daftarmaterial[i].jenis_material
             << left << setw(15) << daftarmaterial[i].keterangan
             << left << setw(10) << daftarmaterial[i].berat
             << left << setw(10) << daftarmaterial[i].stok
             << left << setw(10) << daftarmaterial[i].harga
             << "\n";
    }
}
//todo
void tambahmaterial() {
    if (jumlahmaterial >= MAX_material) {
        cout << "Array penuh, tidak bisa menambah material lagi.\n";
        return;
    }

    material b;
    cout << "Masukkan ID         : ";
    cin >> b.id;
    cin.ignore(); // bersihkan newline

    if (cariIndexById(b.id) != -1) {
        cout << "ID sudah digunakan, silakan pakai ID lain.\n";
        return;
    }

    cout << "Masukkan Nama material: ";
    getline(cin, b.nama);

    cout << "Masukkan Stok       : ";
    cin >> b.stok;

    cout << "Masukkan Harga      : ";
    cin >> b.harga;

    daftarmaterial[jumlahmaterial++] = b;
    cout << "material berhasil ditambahkan.\n";
}
//todo
void ubahmaterial() {
    if (jumlahmaterial == 0) {
        cout << "Belum ada data material.\n";
        return;
    }

    int id;
    cout << "Masukkan ID material yang akan diubah: ";
    cin >> id;
    cin.ignore();

    int index = cariIndexById(id);
    if (index == -1) {
        cout << "material dengan ID " << id << " tidak ditemukan.\n";
        return;
    }

    cout << "Data lama:\n";
    cout << "Nama  : " << daftarmaterial[index].nama << "\n";
    cout << "Stok  : " << daftarmaterial[index].stok << "\n";
    cout << "Harga : " << daftarmaterial[index].harga << "\n\n";

    material &b = daftarmaterial[index];
    string input;
    
    cout << "Nama baru (kosongkan jika tidak diubah): ";
    getline(cin, input);
    if (!input.empty()) b.nama = input;

    cout << "Stok baru (isi -1 jika tidak diubah)   : ";
    int stokBaru;
    cin >> stokBaru;
    if (stokBaru != -1) b.stok = stokBaru;

    cout << "Harga baru (isi -1 jika tidak diubah)  : ";
    double hargaBaru;
    cin >> hargaBaru;
    if (hargaBaru != -1) b.harga = hargaBaru;

    cout << "Data material berhasil diubah.\n";
}
//todo
void hapusmaterial() {
    if (jumlahmaterial == 0) {
        cout << "Belum ada data material.\n";
        return;
    }

    int id;
    cout << "Masukkan ID material yang akan dihapus: ";
    cin >> id;

    int index = cariIndexById(id);
    if (index == -1) {
        cout << "material dengan ID " << id << " tidak ditemukan.\n";
        return;
    }

    // Geser elemen setelahnya ke depan
    for (int i = index; i < jumlahmaterial - 1; ++i) {
        daftarmaterial[i] = daftarmaterial[i + 1];
    }
    jumlahmaterial--;

    cout << "material berhasil dihapus.\n";
}

// ================== MENU ==================
void tampilkanMenu() {
    cout << "\n=== MENU CRUD material ===\n";
    cout << "1. Tampilkan Semua material\n";
    cout << "2. Tambah material\n";
    cout << "3. Ubah material\n";
    cout << "4. Hapus material\n";
    cout << "5. Simpan ke File\n";
    cout << "0. Keluar\n";
    cout << "Pilihan: ";
}

int main() {
    string namaFile = "material.txt";
    muatDariFile(namaFile);

    int pilihan;
    do {
        tampilkanMenu();
        cin >> pilihan;
        cin.ignore(); // bersihkan newline

        switch (pilihan) {
            case 1:
                tampilkanmaterial();
                break;
            case 2:
                tambahmaterial();
                break;
            case 3:
                ubahmaterial();
                break;
            case 4:
                hapusmaterial();
                break;
            case 5:
                simpanKeFile(namaFile);
                break;
            case 0:
                cout << "Keluar program...\n";
                break;
            default:
                cout << "Pilihan tidak valid.\n";
        }
    } while (pilihan != 0);

    // Otomatis simpan saat keluar (opsional)
    simpanKeFile(namaFile);

    return 0;
}
